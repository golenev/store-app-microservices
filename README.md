# Store App Microservices

Учебный проект демонстрирует имитацию интернет-магазина: тарифы, каталог товаров и корзина оформлены как набор микросервисов.

## Бизнес-логика
- **tariffs-service** хранит и предоставляет коэффициенты наценки для разных типов товаров. Первый запрос к сервису рассчитывает их из базы и кеширует в Redis, последующие обращения берут данные из кэша.
- **cart-service** принимает сообщения о товарах из Kafka, сохраняет их в PostgreSQL и даёт пользователю API для авторизации, просмотра каталога и работы с корзиной. Перед сохранением товара сервис запрашивает тарифы и применяет наценку.
- **логистическая служба** эмулируется отправкой сообщений в Kafka: поставка товара на склад инициирует начисление наценки через tariffs-service. Кэширование тарифов в Redis избавляет от обращения к базе при каждом сканировании штрихкода.

## Используемые технологии
- **Spring Boot 3, Java 21** – основа микросервисов.
- **Apache Kafka** – получение описаний товаров и асинхронное взаимодействие сервисов.
- **PostgreSQL** – хранение информации о товарах, корзине и заказах.
- **Redis** – кэш тарифов в tariffs-service.
- **WireMock** – эмуляция внешних сервисов в интеграционных тестах.
- **Docker Compose** – запуск инфраструктуры (PostgreSQL, Kafka, Redis, консоли Kafdrop и Redpanda).
- **Testcontainers** – изолированные интеграционные тесты.
- **Kotlin, JUnit 5, Kotest, Rest Assured, Spring JDBC, Allure** – e2e‑тесты и отчётность.

## Запуск
1. Клонируйте репозиторий
   ```bash
   git clone <repo-url>
   ```
2. Поднимите окружение
   ```bash
   docker-compose up -d
   ```
3. Запустите приложение
   ```bash
   mvn spring-boot:run
   ```
4. Откройте [http://localhost:6789/login.html](http://localhost:6789/login.html) и авторизуйтесь.
   Пользователь по умолчанию: `user` / `qwerty`.

## Основные возможности
- **POST `/api/v1/sendToKafka`** — отправка описания товара в Kafka.
  ```bash
  curl -X POST \
    -H "Content-Type: application/json" \
    -d '{"barcodeId":123,"shortName":"Чай","description":"Чёрный чай","price":55,"quantity":10,"addedAtTariffs":"2024-01-01T12:00","isFoodstuff":true}' \
    http://localhost:6789/api/v1/sendToKafka
  ```
- **GET `/api/v1/products`** — список товаров из базы данных.
- **POST `/api/cart`** — добавить товар в корзину (тело запроса `{ "barcodeId": 123 }`).
- **GET `/api/cart`** — содержимое корзины.
- **DELETE `/api/cart/clear`** — очистить корзину.

Сообщения, отправленные в `send-topic`, автоматически сохраняются в базу и доступны через `/api/v1/products` и веб-страницу `products.html`.

Остановить инфраструктуру можно командой `docker-compose down`.

## E2E сценарии
1. **Поток товара:** эмуляция логистической службы отправляет сообщение через `/api/v1/sendToKafka`, товар появляется в `/api/v1/products` и при первом добавлении в корзину получает наценку из кэшированных тарифов. Повторные попытки добавить тот же товар возвращают 400.
2. **Кэш тарифов:** после сброса кэша первый запрос `GET /tariffs?all=true` выполняется медленнее 5 с, повторный — быстрее благодаря Redis, избегая обращения к базе.

## E2E тесты и Allure Report
Тесты написаны на Kotlin с использованием JUnit 5, Kotest и Rest Assured; для отчётности подключён [Allure](https://github.com/allure-framework/allure2).
Чтобы запустить e2e-тесты и сгенерировать отчёт, выполните:
```bash
cd e2e-tests
./gradlew test
./gradlew allureReport
```
Готовый отчёт будет доступен в каталоге `e2e-tests/build/reports/allure-report/index.html`.
Для интерактивного просмотра можно использовать команду `./gradlew allureServe`.
